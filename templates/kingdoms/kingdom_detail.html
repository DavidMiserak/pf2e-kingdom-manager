{% extends "_base.html" %}

{% block title %}{{ kingdom.name }} - PF2E Kingdom Manager{% endblock title %}

{% block content %}
<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <h1 class="mb-0">
        <i class="fa-solid fa-crown me-2 text-warning"></i>{{ kingdom.name }}
    </h1>
    {% if is_gm %}
    <div class="d-flex gap-2">
        <a href="{% url 'kingdoms:kingdom_update' kingdom.pk %}" class="btn btn-outline-secondary btn-sm">
            <i class="fa-solid fa-pen me-1"></i>Edit
        </a>
        <a href="{% url 'kingdoms:member_manage' kingdom.pk %}" class="btn btn-outline-secondary btn-sm">
            <i class="fa-solid fa-users me-1"></i>Members
        </a>
        <a href="{% url 'kingdoms:kingdom_delete' kingdom.pk %}" class="btn btn-outline-danger btn-sm">
            <i class="fa-solid fa-trash me-1"></i>Delete
        </a>
    </div>
    {% endif %}
</div>

<!-- Character Name -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body py-2">
        <form method="post" action="{% url 'kingdoms:update_character_name' kingdom.pk %}" class="row align-items-center g-2">
            {% csrf_token %}
            <div class="col-auto">
                <i class="fa-solid fa-user-pen text-warning opacity-75"></i>
            </div>
            <div class="col-auto">
                <label for="id_character_name" class="col-form-label fw-semibold">Your Character</label>
            </div>
            <div class="col-sm-4 col-md-3">
                <input type="text" name="character_name" value="{{ membership.character_name }}" class="form-control form-control-sm" id="id_character_name" maxlength="100" required>
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-sm btn-warning">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Core Stats Row -->
<div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
        <div class="card text-center border-0 shadow-sm h-100">
            <div class="card-body py-3">
                <div class="text-uppercase text-body-secondary small fw-semibold mb-1">Level</div>
                <div class="display-5 fw-bold text-warning">{{ kingdom.level }}</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card text-center border-0 shadow-sm h-100">
            <div class="card-body py-3">
                <div class="text-uppercase text-body-secondary small fw-semibold mb-1">XP</div>
                <div class="display-5 fw-bold">{{ kingdom.xp }}</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card text-center border-0 shadow-sm h-100">
            <div class="card-body py-3">
                <div class="text-uppercase text-body-secondary small fw-semibold mb-1">Control DC</div>
                <div class="display-5 fw-bold">{{ kingdom.control_dc }}</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card text-center border-0 shadow-sm h-100">
            <div class="card-body py-3">
                <div class="text-uppercase text-body-secondary small fw-semibold mb-1">Size</div>
                <div class="h4 fw-bold mb-0">{{ kingdom.size_category }}</div>
            </div>
        </div>
    </div>
</div>

<!-- Ability Scores -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-transparent border-bottom-0 pt-3">
        <h5 class="mb-0 fw-semibold">
            <i class="fa-solid fa-chart-simple me-2 text-warning opacity-75"></i>Ability Scores
        </h5>
    </div>
    <div class="card-body pt-2">
        <div class="row text-center g-3">
            <div class="col-6 col-md-3">
                <div class="p-3 rounded bg-body-tertiary">
                    <div class="text-uppercase small text-body-secondary fw-semibold">Culture</div>
                    <div class="display-6 fw-bold">{{ kingdom.culture_score }}</div>
                    <div class="badge bg-secondary">{% if kingdom.culture_modifier >= 0 %}+{% endif %}{{ kingdom.culture_modifier }}</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="p-3 rounded bg-body-tertiary">
                    <div class="text-uppercase small text-body-secondary fw-semibold">Economy</div>
                    <div class="display-6 fw-bold">{{ kingdom.economy_score }}</div>
                    <div class="badge bg-secondary">{% if kingdom.economy_modifier >= 0 %}+{% endif %}{{ kingdom.economy_modifier }}</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="p-3 rounded bg-body-tertiary">
                    <div class="text-uppercase small text-body-secondary fw-semibold">Loyalty</div>
                    <div class="display-6 fw-bold">{{ kingdom.loyalty_score }}</div>
                    <div class="badge bg-secondary">{% if kingdom.loyalty_modifier >= 0 %}+{% endif %}{{ kingdom.loyalty_modifier }}</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="p-3 rounded bg-body-tertiary">
                    <div class="text-uppercase small text-body-secondary fw-semibold">Stability</div>
                    <div class="display-6 fw-bold">{{ kingdom.stability_score }}</div>
                    <div class="badge bg-secondary">{% if kingdom.stability_modifier >= 0 %}+{% endif %}{{ kingdom.stability_modifier }}</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Unrest / Fame / Resources -->
<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-transparent border-bottom-0 pt-3">
                <h6 class="mb-0 fw-semibold">
                    <i class="fa-solid fa-person-burst me-2 text-danger opacity-75"></i>Unrest
                </h6>
            </div>
            <div class="card-body text-center pt-0">
                <div class="display-4 fw-bold {% if kingdom.unrest >= 15 %}text-danger{% elif kingdom.unrest >= 5 %}text-warning{% endif %}">
                    {{ kingdom.unrest }}
                </div>
                {% if kingdom.unrest_penalty %}
                <div class="badge bg-danger">{{ kingdom.unrest_penalty }} penalty</div>
                {% else %}
                <small class="text-body-secondary">No penalty</small>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-transparent border-bottom-0 pt-3">
                <h6 class="mb-0 fw-semibold">
                    <i class="fa-solid fa-star me-2 text-warning opacity-75"></i>{{ kingdom.get_fame_type_display }}
                </h6>
            </div>
            <div class="card-body text-center pt-0">
                <div class="display-4 fw-bold">{{ kingdom.fame_points }}</div>
                <small class="text-body-secondary">points</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-transparent border-bottom-0 pt-3">
                <h6 class="mb-0 fw-semibold">
                    <i class="fa-solid fa-coins me-2 text-warning opacity-75"></i>Resources
                </h6>
            </div>
            <div class="card-body text-center pt-0">
                <div class="display-4 fw-bold">{{ kingdom.resource_points }}</div>
                <small class="text-body-secondary">{{ kingdom.resource_die_type }} | +{{ kingdom.bonus_dice }}/-{{ kingdom.penalty_dice }} dice</small>
            </div>
        </div>
    </div>
</div>

<!-- Ruin Counters -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-transparent border-bottom-0 pt-3">
        <h5 class="mb-0 fw-semibold">
            <i class="fa-solid fa-skull me-2 text-danger opacity-75"></i>Ruin
        </h5>
    </div>
    <div class="card-body pt-2">
        <div class="row text-center g-3">
            <div class="col-6 col-md-3">
                <div class="small text-uppercase text-body-secondary fw-semibold">Corruption</div>
                <div class="fs-4 fw-bold">{{ kingdom.corruption_points }}<span class="text-body-secondary fw-normal">/{{ kingdom.corruption_threshold }}</span></div>
                <small class="text-body-secondary">vs Culture</small>
                {% if kingdom.corruption_penalty %}<div class="badge bg-danger mt-1">-{{ kingdom.corruption_penalty }}</div>{% endif %}
            </div>
            <div class="col-6 col-md-3">
                <div class="small text-uppercase text-body-secondary fw-semibold">Crime</div>
                <div class="fs-4 fw-bold">{{ kingdom.crime_points }}<span class="text-body-secondary fw-normal">/{{ kingdom.crime_threshold }}</span></div>
                <small class="text-body-secondary">vs Economy</small>
                {% if kingdom.crime_penalty %}<div class="badge bg-danger mt-1">-{{ kingdom.crime_penalty }}</div>{% endif %}
            </div>
            <div class="col-6 col-md-3">
                <div class="small text-uppercase text-body-secondary fw-semibold">Strife</div>
                <div class="fs-4 fw-bold">{{ kingdom.strife_points }}<span class="text-body-secondary fw-normal">/{{ kingdom.strife_threshold }}</span></div>
                <small class="text-body-secondary">vs Loyalty</small>
                {% if kingdom.strife_penalty %}<div class="badge bg-danger mt-1">-{{ kingdom.strife_penalty }}</div>{% endif %}
            </div>
            <div class="col-6 col-md-3">
                <div class="small text-uppercase text-body-secondary fw-semibold">Decay</div>
                <div class="fs-4 fw-bold">{{ kingdom.decay_points }}<span class="text-body-secondary fw-normal">/{{ kingdom.decay_threshold }}</span></div>
                <small class="text-body-secondary">vs Stability</small>
                {% if kingdom.decay_penalty %}<div class="badge bg-danger mt-1">-{{ kingdom.decay_penalty }}</div>{% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Commodities -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-transparent border-bottom-0 pt-3">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-semibold">
                <i class="fa-solid fa-boxes-stacked me-2 text-warning opacity-75"></i>Commodities
            </h5>
            <span class="badge bg-secondary">Max {{ kingdom.commodity_storage_limit }} each</span>
        </div>
    </div>
    <div class="card-body pt-2">
        <div class="row text-center g-3">
            <div class="col">
                <div class="p-2 rounded bg-body-tertiary">
                    <i class="fa-solid fa-wheat-awn text-success mb-1"></i>
                    <div class="small text-body-secondary">Food</div>
                    <div class="fs-4 fw-bold">{{ kingdom.food }}</div>
                </div>
            </div>
            <div class="col">
                <div class="p-2 rounded bg-body-tertiary">
                    <i class="fa-solid fa-tree text-success mb-1"></i>
                    <div class="small text-body-secondary">Lumber</div>
                    <div class="fs-4 fw-bold">{{ kingdom.lumber }}</div>
                </div>
            </div>
            <div class="col">
                <div class="p-2 rounded bg-body-tertiary">
                    <i class="fa-solid fa-gem text-info mb-1"></i>
                    <div class="small text-body-secondary">Ore</div>
                    <div class="fs-4 fw-bold">{{ kingdom.ore }}</div>
                </div>
            </div>
            <div class="col">
                <div class="p-2 rounded bg-body-tertiary">
                    <i class="fa-solid fa-cubes text-secondary mb-1"></i>
                    <div class="small text-body-secondary">Stone</div>
                    <div class="fs-4 fw-bold">{{ kingdom.stone }}</div>
                </div>
            </div>
            <div class="col">
                <div class="p-2 rounded bg-body-tertiary">
                    <i class="fa-solid fa-gem text-warning mb-1"></i>
                    <div class="small text-body-secondary">Luxuries</div>
                    <div class="fs-4 fw-bold">{{ kingdom.luxuries }}</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Turns -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-transparent border-bottom-0 pt-3 d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-semibold">
            <i class="fa-solid fa-calendar-days me-2 text-warning opacity-75"></i>Turns
        </h5>
        {% if is_gm %}
        <a href="{% url 'kingdoms:turn_create' kingdom.pk %}" class="btn btn-warning btn-sm">
            <i class="fa-solid fa-plus me-1"></i>New Turn
        </a>
        {% endif %}
    </div>
    <div class="card-body p-0">
        {% if turns %}
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead>
                    <tr class="text-body-secondary small text-uppercase">
                        <th class="ps-3">Turn</th>
                        <th>Month</th>
                        <th>Activities</th>
                        <th>XP</th>
                        <th class="pe-3">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for turn in turns %}
                    <tr style="cursor: pointer;" onclick="window.location='{% url 'kingdoms:turn_detail' kingdom.pk turn.pk %}';">
                        <td class="ps-3 fw-semibold">{{ turn.turn_number }}</td>
                        <td>{{ turn.in_game_month|default:"—" }}</td>
                        <td>{{ turn.activity_count }}</td>
                        <td>{{ turn.xp_gained|default:"—" }}</td>
                        <td class="pe-3">
                            {% if turn.is_complete %}
                            <span class="badge bg-success">Complete</span>
                            {% if turn.leveled_up %}<span class="badge bg-warning text-dark ms-1">Level Up!</span>{% endif %}
                            {% else %}
                            <span class="badge bg-primary">In Progress</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="card-body text-center text-body-secondary py-4">
            <i class="fa-solid fa-calendar-xmark fa-2x mb-2 opacity-25"></i>
            <p class="mb-0">No turns recorded yet.</p>
            {% if is_gm %}
            <p class="small mb-0">Click "New Turn" to start tracking.</p>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Leadership -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-transparent border-bottom-0 pt-3 d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-semibold">
            <i class="fa-solid fa-users me-2 text-warning opacity-75"></i>Leadership
        </h5>
        {% if is_gm %}
        <a href="{% url 'kingdoms:leadership_update' kingdom.pk %}" class="btn btn-outline-warning btn-sm">
            <i class="fa-solid fa-pen me-1"></i>Edit
        </a>
        {% endif %}
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead>
                    <tr class="text-body-secondary small text-uppercase">
                        <th class="ps-3">Role</th>
                        <th>Key Ability</th>
                        <th>Character</th>
                        <th>Status</th>
                        <th class="pe-3">Invested</th>
                    </tr>
                </thead>
                <tbody>
                    {% for assignment in leadership %}
                    <tr>
                        <td class="ps-3 fw-semibold">{{ assignment.get_role_display }}</td>
                        <td class="text-body-secondary">{{ assignment.get_key_ability_display }}</td>
                        <td>
                            {% if assignment.is_vacant %}
                            <span class="text-danger fst-italic">Vacant</span>
                            {% else %}
                            {{ assignment.display_name }}
                            {% if assignment.is_pc %}<span class="badge bg-info ms-1">PC</span>{% endif %}
                            {% endif %}
                        </td>
                        <td>
                            {% if assignment.is_vacant %}
                            <span class="badge bg-danger">Vacant</span>
                            {% elif assignment.downtime_fulfilled %}
                            <span class="badge bg-success">Active</span>
                            {% else %}
                            <span class="badge bg-warning text-dark">No Downtime</span>
                            {% endif %}
                        </td>
                        <td class="pe-3">
                            {% if assignment.is_invested %}
                            <span class="badge bg-primary">+{{ assignment.status_bonus }}</span>
                            {% else %}
                            <span class="text-body-secondary">—</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Skills -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-transparent border-bottom-0 pt-3 d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-semibold">
            <i class="fa-solid fa-book me-2 text-warning opacity-75"></i>Skills
        </h5>
        {% if is_gm %}
        <a href="{% url 'kingdoms:skills_update' kingdom.pk %}" class="btn btn-outline-warning btn-sm">
            <i class="fa-solid fa-pen me-1"></i>Edit
        </a>
        {% endif %}
    </div>
    <div class="card-body">
        {% for ability_label, skills in skills_by_ability.items %}
        <h6 class="text-uppercase text-body-secondary small fw-semibold mt-3 mb-2 {% if forloop.first %}mt-0{% endif %}">
            {{ ability_label }}
        </h6>
        <div class="row g-2">
            {% for skill in skills %}
            <div class="col-6 col-md-4 col-lg-3">
                <div class="d-flex justify-content-between align-items-center p-2 rounded bg-body-tertiary small">
                    <span>{{ skill.get_skill_display }}</span>
                    <span>
                        {% if skill.proficiency != "untrained" %}
                        <span class="badge bg-secondary me-1">{{ skill.get_proficiency_display|slice:":1" }}</span>
                        {% endif %}
                        <span class="fw-bold">+{{ skill.proficiency_bonus|default:"0" }}</span>
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>
</div>
{% endblock content %}
