{% extends "_base.html" %}

{% block title %}{{ kingdom.name }} - PF2E Kingdom Manager{% endblock title %}

{% block content %}
<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <div>
        <h1 class="mb-0">
            <i class="fa-solid fa-crown me-2 text-warning"></i>{{ kingdom.name }}
        </h1>
        {% if kingdom.charter or kingdom.heartland or kingdom.government %}
        <div class="d-flex flex-wrap align-items-center gap-2 ms-md-5 ps-md-2 mt-2">
            {% if kingdom.charter %}
            <span class="badge bg-body-tertiary text-body-secondary">
                <i class="fa-solid fa-scroll me-1"></i>{{ kingdom.get_charter_display }}
            </span>
            {% endif %}
            {% if kingdom.heartland %}
            <span class="badge bg-body-tertiary text-body-secondary">
                <i class="fa-solid fa-mountain-sun me-1"></i>{{ kingdom.get_heartland_display }}
            </span>
            {% endif %}
            {% if kingdom.government %}
            <span class="badge bg-body-tertiary text-body-secondary">
                <i class="fa-solid fa-landmark me-1"></i>{{ kingdom.get_government_display }}
            </span>
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% if is_gm %}
    <div class="d-flex gap-2">
        <a href="{% url 'kingdoms:kingdom_update' kingdom.pk %}" class="btn btn-outline-secondary btn-sm">
            <i class="fa-solid fa-pen me-1"></i>Edit
        </a>
        <a href="{% url 'kingdoms:member_manage' kingdom.pk %}" class="btn btn-outline-secondary btn-sm">
            <i class="fa-solid fa-users me-1"></i>Members
        </a>
        <a href="{% url 'kingdoms:kingdom_delete' kingdom.pk %}" class="btn btn-outline-danger btn-sm">
            <i class="fa-solid fa-trash me-1"></i>Delete
        </a>
    </div>
    {% endif %}
</div>

<!-- Character Name -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body py-2">
        <form method="post" action="{% url 'kingdoms:update_character_name' kingdom.pk %}" class="row align-items-center g-2">
            {% csrf_token %}
            <div class="col-auto">
                <i class="fa-solid fa-user-pen text-warning opacity-75"></i>
            </div>
            <div class="col-auto">
                <label for="id_character_name" class="col-form-label fw-semibold">Your Character</label>
            </div>
            <div class="col col-sm-4 col-md-3">
                <input type="text" name="character_name" value="{{ membership.character_name }}" class="form-control form-control-sm" id="id_character_name" maxlength="100" required>
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-sm btn-warning">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Stats bar: single card with all key numbers -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body py-3">
        <div class="row text-center g-3">
            <div class="col-4 col-lg-2">
                <div class="text-uppercase text-body-secondary small fw-semibold">Level</div>
                <div class="fs-4 fw-bold text-warning">{{ kingdom.level }}</div>
                <div class="text-body-secondary small">{{ kingdom.xp }} XP</div>
            </div>
            <div class="col-4 col-lg-2">
                <div class="text-uppercase text-body-secondary small fw-semibold">Control DC</div>
                <div class="fs-4 fw-bold">{{ kingdom.control_dc }}</div>
                <div class="text-body-secondary small">{{ kingdom.size_category }}</div>
            </div>
            <div class="col-4 col-lg-2">
                <div class="text-uppercase text-body-secondary small fw-semibold">Size</div>
                <div class="fs-4 fw-bold">{{ kingdom.claimed_hexes }}</div>
                <div class="text-body-secondary small">hex{{ kingdom.claimed_hexes|pluralize:"es" }}</div>
            </div>
            <div class="col-4 col-lg-2">
                <div class="text-uppercase text-body-secondary small fw-semibold">Resources</div>
                <div class="fs-4 fw-bold">{{ kingdom.resource_points }}</div>
                <div class="text-body-secondary small">{{ kingdom.resource_die_type }} +{{ kingdom.bonus_dice }}/-{{ kingdom.penalty_dice }}</div>
            </div>
            <div class="col-4 col-lg-2">
                <div class="text-uppercase text-body-secondary small fw-semibold">Unrest</div>
                <div class="fs-4 fw-bold {% if kingdom.unrest >= 15 %}text-danger{% elif kingdom.unrest >= 5 %}text-warning{% endif %}">{{ kingdom.unrest }}</div>
                {% if kingdom.unrest_penalty %}
                <div class="text-danger small">{{ kingdom.unrest_penalty }} penalty</div>
                {% else %}
                <div class="text-body-secondary small">No penalty</div>
                {% endif %}
            </div>
            <div class="col-4 col-lg-2">
                <div class="text-uppercase text-body-secondary small fw-semibold">{{ kingdom.get_fame_type_display }}</div>
                <div class="fs-4 fw-bold">{{ kingdom.fame_points }}</div>
                <div class="text-body-secondary small">points</div>
            </div>
        </div>
    </div>
</div>

<!-- Ability Scores + Skills (grouped by ability) -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0 fw-semibold">
        <i class="fa-solid fa-chart-simple me-2 text-warning opacity-75"></i>Abilities &amp; Skills
    </h5>
    {% if is_gm %}
    <a href="{% url 'kingdoms:skills_update' kingdom.pk %}" class="btn btn-outline-warning btn-sm">
        <i class="fa-solid fa-pen me-1"></i>Edit Skills
    </a>
    {% endif %}
</div>
<div class="row g-3 mb-4">
    {% for ability_label, ability_data in abilities_data.items %}
    <div class="col-6 col-lg-3">
        <div class="card border-0 shadow-sm">
            <!-- Ability score header -->
            <div class="card-header bg-transparent border-bottom text-center py-3">
                <div class="text-uppercase small text-body-secondary fw-semibold">{{ ability_label }}</div>
                {% if ability_label == "Culture" %}
                <div class="fs-2 fw-bold mb-0">{{ kingdom.culture_score }}</div>
                <span class="badge bg-secondary">{% if kingdom.culture_modifier >= 0 %}+{% endif %}{{ kingdom.culture_modifier }}</span>
                {% elif ability_label == "Economy" %}
                <div class="fs-2 fw-bold mb-0">{{ kingdom.economy_score }}</div>
                <span class="badge bg-secondary">{% if kingdom.economy_modifier >= 0 %}+{% endif %}{{ kingdom.economy_modifier }}</span>
                {% elif ability_label == "Loyalty" %}
                <div class="fs-2 fw-bold mb-0">{{ kingdom.loyalty_score }}</div>
                <span class="badge bg-secondary">{% if kingdom.loyalty_modifier >= 0 %}+{% endif %}{{ kingdom.loyalty_modifier }}</span>
                {% elif ability_label == "Stability" %}
                <div class="fs-2 fw-bold mb-0">{{ kingdom.stability_score }}</div>
                <span class="badge bg-secondary">{% if kingdom.stability_modifier >= 0 %}+{% endif %}{{ kingdom.stability_modifier }}</span>
                {% endif %}
                <!-- Boost/flaw source pills -->
                <div class="d-flex flex-wrap justify-content-center gap-1 mt-2">
                    {% for effect in ability_data.effects %}
                    {% if effect.type == "boost" %}
                    <span class="badge bg-success bg-opacity-25 text-success">{{ effect.source }}{% if effect.free %} <span class="fw-normal fst-italic">(free)</span>{% endif %}</span>
                    {% else %}
                    <span class="badge bg-danger bg-opacity-25 text-danger">{{ effect.source }}</span>
                    {% endif %}
                    {% endfor %}
                    {% if not ability_data.effects %}
                    <span class="badge invisible">placeholder</span>
                    {% endif %}
                </div>
            </div>
            <!-- Ruin for this ability -->
            <div class="card-body py-2 border-bottom">
                <div class="d-flex justify-content-between align-items-center small">
                    {% if ability_label == "Culture" %}
                    <span class="text-body-secondary"><i class="fa-solid fa-skull me-1 text-danger opacity-75"></i>Corruption</span>
                    <span class="fw-bold">{{ kingdom.corruption_points }}/{{ kingdom.corruption_threshold }}{% if kingdom.corruption_penalty %} <span class="badge bg-danger">-{{ kingdom.corruption_penalty }}</span>{% endif %}</span>
                    {% elif ability_label == "Economy" %}
                    <span class="text-body-secondary"><i class="fa-solid fa-skull me-1 text-danger opacity-75"></i>Crime</span>
                    <span class="fw-bold">{{ kingdom.crime_points }}/{{ kingdom.crime_threshold }}{% if kingdom.crime_penalty %} <span class="badge bg-danger">-{{ kingdom.crime_penalty }}</span>{% endif %}</span>
                    {% elif ability_label == "Loyalty" %}
                    <span class="text-body-secondary"><i class="fa-solid fa-skull me-1 text-danger opacity-75"></i>Strife</span>
                    <span class="fw-bold">{{ kingdom.strife_points }}/{{ kingdom.strife_threshold }}{% if kingdom.strife_penalty %} <span class="badge bg-danger">-{{ kingdom.strife_penalty }}</span>{% endif %}</span>
                    {% elif ability_label == "Stability" %}
                    <span class="text-body-secondary"><i class="fa-solid fa-skull me-1 text-danger opacity-75"></i>Decay</span>
                    <span class="fw-bold">{{ kingdom.decay_points }}/{{ kingdom.decay_threshold }}{% if kingdom.decay_penalty %} <span class="badge bg-danger">-{{ kingdom.decay_penalty }}</span>{% endif %}</span>
                    {% endif %}
                </div>
            </div>
            <!-- Skills for this ability -->
            <ul class="list-group list-group-flush">
                {% for skill in ability_data.skills %}
                <li class="list-group-item d-flex justify-content-between align-items-center py-2 border-0">
                    <span class="small">
                        {{ skill.get_skill_display }}
                        {% if skill.government_boosted %}<i class="fa-solid fa-landmark ms-1 text-warning opacity-75" title="Government skill"></i>{% endif %}
                    </span>
                    <span>
                        {% if skill.proficiency != "untrained" %}
                        <span class="badge bg-secondary me-1">{{ skill.get_proficiency_display|slice:":1" }}</span>
                        {% endif %}
                        <span class="fw-bold small">+{{ skill.proficiency_bonus|default:"0" }}</span>
                    </span>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Two-column: Commodities + Leadership side by side -->
<div class="row g-3 mb-4">
    <!-- Commodities -->
    <div class="col-lg-5">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-transparent border-bottom-0 pt-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-semibold">
                        <i class="fa-solid fa-boxes-stacked me-2 text-warning opacity-75"></i>Commodities
                    </h5>
                    <span class="badge bg-secondary">Max {{ kingdom.commodity_storage_limit }}</span>
                </div>
            </div>
            <div class="card-body pt-2">
                <div class="row text-center g-2">
                    <div class="col-4 col-sm">
                        <div class="p-2 rounded bg-body-tertiary">
                            <i class="fa-solid fa-wheat-awn text-success mb-1"></i>
                            <div class="small text-body-secondary">Food</div>
                            <div class="fs-5 fw-bold">{{ kingdom.food }}</div>
                        </div>
                    </div>
                    <div class="col-4 col-sm">
                        <div class="p-2 rounded bg-body-tertiary">
                            <i class="fa-solid fa-tree text-success mb-1"></i>
                            <div class="small text-body-secondary">Lumber</div>
                            <div class="fs-5 fw-bold">{{ kingdom.lumber }}</div>
                        </div>
                    </div>
                    <div class="col-4 col-sm">
                        <div class="p-2 rounded bg-body-tertiary">
                            <i class="fa-solid fa-gem text-info mb-1"></i>
                            <div class="small text-body-secondary">Ore</div>
                            <div class="fs-5 fw-bold">{{ kingdom.ore }}</div>
                        </div>
                    </div>
                    <div class="col-6 col-sm">
                        <div class="p-2 rounded bg-body-tertiary">
                            <i class="fa-solid fa-cubes text-secondary mb-1"></i>
                            <div class="small text-body-secondary">Stone</div>
                            <div class="fs-5 fw-bold">{{ kingdom.stone }}</div>
                        </div>
                    </div>
                    <div class="col-6 col-sm">
                        <div class="p-2 rounded bg-body-tertiary">
                            <i class="fa-solid fa-gem text-warning mb-1"></i>
                            <div class="small text-body-secondary">Luxuries</div>
                            <div class="fs-5 fw-bold">{{ kingdom.luxuries }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leadership -->
    <div class="col-lg-7">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-transparent border-bottom-0 pt-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-semibold">
                    <i class="fa-solid fa-users me-2 text-warning opacity-75"></i>Leadership
                </h5>
                {% if is_gm %}
                <a href="{% url 'kingdoms:leadership_update' kingdom.pk %}" class="btn btn-outline-warning btn-sm">
                    <i class="fa-solid fa-pen me-1"></i>Edit
                </a>
                {% endif %}
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0 table-sm">
                        <thead>
                            <tr class="text-body-secondary small text-uppercase">
                                <th class="ps-3">Role</th>
                                <th class="d-none d-md-table-cell">Ability</th>
                                <th>Character</th>
                                <th>Status</th>
                                <th class="pe-3 text-end d-none d-sm-table-cell">Invested</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for assignment in leadership %}
                            <tr>
                                <td class="ps-3 fw-semibold">{{ assignment.get_role_display }}</td>
                                <td class="text-body-secondary small d-none d-md-table-cell">{{ assignment.get_key_ability_display }}</td>
                                <td>
                                    {% if assignment.is_vacant %}
                                    <span class="text-danger fst-italic">Vacant</span>
                                    {% else %}
                                    {{ assignment.display_name }}
                                    {% if assignment.is_pc %}<span class="badge bg-info ms-1">PC</span>{% endif %}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if assignment.is_vacant %}
                                    <span class="badge bg-danger">Vacant</span>
                                    {% elif assignment.downtime_fulfilled %}
                                    <span class="badge bg-success">Active</span>
                                    {% else %}
                                    <span class="badge bg-warning text-dark">No Downtime</span>
                                    {% endif %}
                                </td>
                                <td class="pe-3 text-end d-none d-sm-table-cell">
                                    {% if assignment.is_invested %}
                                    <span class="badge bg-primary">+{{ assignment.status_bonus }}</span>
                                    {% else %}
                                    <span class="text-body-secondary">&mdash;</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Turns -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-transparent border-bottom-0 pt-3 d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-semibold">
            <i class="fa-solid fa-calendar-days me-2 text-warning opacity-75"></i>Turns
        </h5>
        {% if is_gm %}
        <a href="{% url 'kingdoms:turn_create' kingdom.pk %}" class="btn btn-warning btn-sm">
            <i class="fa-solid fa-plus me-1"></i>New Turn
        </a>
        {% endif %}
    </div>
    <div class="card-body p-0">
        {% if turns %}
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead>
                    <tr class="text-body-secondary small text-uppercase">
                        <th class="ps-3">Turn</th>
                        <th>Month</th>
                        <th>Activities</th>
                        <th>XP</th>
                        <th class="pe-3">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for turn in turns %}
                    <tr style="cursor: pointer;" onclick="window.location='{% url 'kingdoms:turn_detail' kingdom.pk turn.pk %}';">
                        <td class="ps-3 fw-semibold">{{ turn.turn_number }}</td>
                        <td>{{ turn.get_in_game_month_display|default:"—" }}</td>
                        <td>{{ turn.activity_count }}</td>
                        <td>{{ turn.xp_gained|default:"—" }}</td>
                        <td class="pe-3">
                            {% if turn.is_complete %}
                            <span class="badge bg-success">Complete</span>
                            {% if turn.leveled_up %}<span class="badge bg-warning text-dark ms-1">Level Up!</span>{% endif %}
                            {% else %}
                            <span class="badge bg-primary">In Progress</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="card-body text-center text-body-secondary py-4">
            <i class="fa-solid fa-calendar-xmark fa-2x mb-2 opacity-25"></i>
            <p class="mb-0">No turns recorded yet.</p>
            {% if is_gm %}
            <p class="small mb-0">Click "New Turn" to start tracking.</p>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock content %}
